<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - LearnHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', -apple-system, sans-serif; background: #f7f9fa; color: #1f1f1f; }
        
        .navbar { background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 0 40px; position: sticky; top: 0; z-index: 1000; }
        .navbar-container { max-width: 1440px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 72px; }
        .logo { font-size: 28px; font-weight: 700; color: #0056d2; cursor: pointer; }
        
        .payment-container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .payment-header { text-align: center; margin-bottom: 40px; }
        .payment-header h1 { font-size: 32px; margin-bottom: 8px; }
        .payment-header p { color: #666; font-size: 16px; }
        
        .payment-grid { display: grid; grid-template-columns: 1fr 400px; gap: 32px; }
        
        .payment-section { background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #1f1f1f; }
        .form-group input, .form-group select { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #0056d2; }
        
        .payment-methods { display: flex; gap: 16px; margin-bottom: 24px; }
        .payment-method { flex: 1; padding: 16px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .payment-method:hover { border-color: #0056d2; }
        .payment-method.active { border-color: #0056d2; background: #f0f7ff; }
        .payment-method i { font-size: 32px; color: #0056d2; margin-bottom: 8px; }
        .payment-method span { display: block; font-size: 14px; font-weight: 600; }
        
        .order-summary { background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .course-info { display: flex; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid #f0f0f0; }
        .course-thumbnail { width: 120px; height: 80px; border-radius: 4px; object-fit: cover; background: linear-gradient(135deg, #667eea, #764ba2); }
        .course-details h3 { font-size: 16px; margin-bottom: 8px; }
        .course-details p { font-size: 14px; color: #666; }
        
        .price-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .price-row.total { font-size: 20px; font-weight: 700; padding-top: 16px; border-top: 2px solid #f0f0f0; margin-top: 16px; }
        
        .btn { padding: 14px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none; font-size: 16px; transition: all 0.3s; }
        .btn-primary { background: #0056d2; color: #fff; width: 100%; }
        .btn-primary:hover { background: #004bb5; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        .security-notice { display: flex; align-items: center; gap: 8px; margin-top: 16px; padding: 12px; background: #f0f7ff; border-radius: 4px; font-size: 14px; color: #0056d2; }
        
        .alert { padding: 12px 16px; border-radius: 4px; margin-bottom: 16px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        @media (max-width: 768px) {
            .payment-grid { grid-template-columns: 1fr; }
            .order-summary { order: -1; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo" onclick="window.location.href='/'">
                <i class="fas fa-graduation-cap"></i> LearnHub
            </div>
        </div>
    </nav>

    <div class="payment-container">
        <div class="payment-header">
            <h1>Complete Your Enrollment</h1>
            <p>Secure payment powered by LearnHub</p>
        </div>

        <div id="alertContainer"></div>

        <div class="payment-grid">
            <div class="payment-section">
                <h2 class="section-title">Payment Method</h2>
                
                <div class="payment-methods">
                    <div class="payment-method active" onclick="selectPaymentMethod('card')">
                        <i class="fas fa-credit-card"></i>
                        <span>Credit/Debit Card</span>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('paypal')">
                        <i class="fab fa-paypal"></i>
                        <span>PayPal</span>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('upi')">
                        <i class="fas fa-mobile-alt"></i>
                        <span>UPI</span>
                    </div>
                </div>

                <form id="paymentForm">
                    <div id="cardPayment">
                        <div class="form-group">
                            <label>Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                            </div>
                            <div class="form-group">
                                <label>CVV</label>
                                <input type="text" id="cvv" placeholder="123" maxlength="3" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardholderName" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div id="paypalPayment" style="display: none;">
                        <p style="text-align: center; padding: 40px; color: #666;">
                            You'll be redirected to PayPal to complete your payment
                        </p>
                    </div>

                    <div id="upiPayment" style="display: none;">
                        <div class="form-group">
                            <label>UPI ID</label>
                            <input type="text" id="upiId" placeholder="yourname@upi">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="payButton">
                        <i class="fas fa-lock"></i> Pay Now
                    </button>
                </form>

                <div class="security-notice">
                    <i class="fas fa-shield-alt"></i>
                    <span>Your payment information is secure and encrypted</span>
                </div>
            </div>

            <div class="order-summary">
                <h2 class="section-title">Order Summary</h2>
                
                <div class="course-info" id="courseInfo">
                    <div class="course-thumbnail" id="courseThumbnail"></div>
                    <div class="course-details">
                        <h3 id="courseTitle">Loading...</h3>
                        <p id="courseInstructor">Loading instructor...</p>
                    </div>
                </div>

                <div class="price-row">
                    <span>Course Price</span>
                    <span id="coursePrice">$0.00</span>
                </div>
                <div class="price-row">
                    <span>Tax (if applicable)</span>
                    <span id="taxAmount">$0.00</span>
                </div>
                <div class="price-row total">
                    <span>Total</span>
                    <span id="totalAmount">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course_id');
        let selectedPaymentMethod = 'card';
        let courseData = null;

        // Redirect if not logged in
        if (!token) {
            alert('Please login to continue');
            window.location.href = '/';
        }

        if (!courseId) {
            alert('No course selected');
            window.location.href = '/courses';
        }

        // Load course details
        async function loadCourse() {
            try {
                const response = await fetch(`${API_BASE}/student/courses/${courseId}`);
                const data = await response.json();

                if (data.success && data.course) {
                    courseData = data.course;
                    displayCourseInfo(data.course);
                } else {
                    showAlert('Failed to load course details', 'error');
                }
            } catch (error) {
                console.error('Error loading course:', error);
                showAlert('Error loading course details', 'error');
            }
        }

        function displayCourseInfo(course) {
            document.getElementById('courseTitle').textContent = course.title;
            document.getElementById('courseInstructor').textContent = `By ${course.instructor_name || 'Instructor'}`;
            
            const price = parseFloat(course.price || 0);
            const tax = price * 0.0; // 0% tax for now
            const total = price + tax;

            document.getElementById('coursePrice').textContent = `$${price.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update active state
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.payment-method').classList.add('active');

            // Show/hide payment forms
            document.getElementById('cardPayment').style.display = method === 'card' ? 'block' : 'none';
            document.getElementById('paypalPayment').style.display = method === 'paypal' ? 'block' : 'none';
            document.getElementById('upiPayment').style.display = method === 'upi' ? 'block' : 'none';
        }

        // Format card number
        document.getElementById('cardNumber')?.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Format expiry date
        document.getElementById('expiryDate')?.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Handle payment
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                // Quick token validity check (client-side) to avoid server 401s
                function isTokenValid(tok){
                    if(!tok) return false;
                    try{
                        const parts = tok.split('.');
                        if(parts.length!==3) return false;
                        const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
                        if(!payload.exp) return false;
                        const now = Math.floor(Date.now()/1000);
                        return payload.exp > now;
                    }catch(err){
                        return false;
                    }
                }

                if(!isTokenValid(token)){
                    showAlert('Your session has expired. Please login again to complete the enrollment.', 'error');
                    setTimeout(()=>{ window.location.href = '/login'; }, 1500);
                    return;
                }

                // If course is free, skip payment flow and directly enroll the student
                const total = parseFloat(courseData.price || 0);
                if(total === 0){
                    // Direct enroll (student role required)
                    const enrollRes = await fetch(`${API_BASE}/student/enroll`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ course_id: courseId })
                    });

                    const enrollData = await enrollRes.json();
                    if(enrollData.success){
                        showAlert('Enrollment successful! Redirecting...', 'success');
                        setTimeout(()=> window.location.href = '/student/dashboard', 1200);
                        return;
                    } else {
                        throw new Error(enrollData.error || 'Enrollment failed');
                    }
                }

                // Step 1: Create payment record
                const createResponse = await fetch(`${API_BASE}/student/payments/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        amount: parseFloat(courseData.price || 0)
                    })
                });

                const createData = await createResponse.json();

                if (!createData.success) {
                    throw new Error(createData.error || 'Failed to create payment');
                }

                // Step 2: Process payment
                showAlert('Processing payment...', 'success');
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Step 3: Complete payment
                const completeResponse = await fetch(`${API_BASE}/student/payments/${createData.payment.payment_id}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        payment_method: selectedPaymentMethod,
                        gateway_transaction_id: 'TXN-' + Date.now(),
                        gateway_response: {
                            status: 'success',
                            method: selectedPaymentMethod
                        }
                    })
                });

                const completeData = await completeResponse.json();

                if (completeData.success) {
                    showAlert('Payment successful! Enrollment complete. Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/student/dashboard';
                    }, 2000);
                } else {
                    throw new Error(completeData.error || 'Payment failed');
                }

            } catch (error) {
                console.error('Payment error:', error);
                showAlert(error.message || 'Payment failed. Please try again.', 'error');
                payButton.disabled = false;
                payButton.innerHTML = '<i class="fas fa-lock"></i> Pay Now';
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Initialize
        loadCourse();
    </script>
</body>
</html>