<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - LearnHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', -apple-system, sans-serif; background: #f7f9fa; color: #1f1f1f; }
        
        .navbar { background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 0 40px; position: sticky; top: 0; z-index: 1000; }
        .navbar-container { max-width: 1440px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 72px; }
        .logo { font-size: 24px; font-weight: 700; color: #0056d2; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .back-btn { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #e0e0e0; }
        
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .page-header { margin-bottom: 32px; }
        .page-header h1 { font-size: 32px; margin-bottom: 8px; }
        .page-header p { color: #666; font-size: 16px; }
        
        .creation-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        
        .card { background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .card-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #1f1f1f; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #0056d2; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .btn { padding: 12px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none; font-size: 15px; transition: all 0.3s; }
        .btn-primary { background: #0056d2; color: #fff; }
        .btn-primary:hover { background: #004bb5; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #f0f0f0; color: #1f1f1f; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .btn-block { width: 100%; }
        
        .upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #0056d2; background: #f8f9fa; }
        .upload-area i { font-size: 48px; color: #0056d2; margin-bottom: 16px; }
        .upload-area input { display: none; }
        
        .materials-list { list-style: none; }
        .material-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 4px; margin-bottom: 8px; }
        .material-item i { margin-right: 8px; color: #0056d2; }
        .remove-btn { background: #dc3545; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .remove-btn:hover { background: #c82333; }
        
        .live-class-item { padding: 16px; background: #f8f9fa; border-left: 4px solid #0056d2; border-radius: 4px; margin-bottom: 12px; }
        .live-class-item h4 { margin-bottom: 8px; }
        .live-class-item p { color: #666; font-size: 14px; margin-bottom: 4px; }
        
        .preview-card { position: sticky; top: 92px; }
        .course-preview { border-radius: 8px; overflow: hidden; }
        .preview-image { width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 48px; }
        .preview-content { padding: 20px; }
        .preview-content h3 { margin-bottom: 12px; }
        .preview-content p { color: #666; font-size: 14px; margin-bottom: 16px; }
        .preview-meta { display: flex; justify-content: space-between; padding-top: 16px; border-top: 1px solid #f0f0f0; }
        .preview-meta-item { text-align: center; }
        .preview-meta-item strong { display: block; color: #0056d2; font-size: 18px; }
        .preview-meta-item span { font-size: 13px; color: #666; }
        
        .alert { padding: 12px 16px; border-radius: 4px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .tag-input-wrapper { display: flex; gap: 8px; flex-wrap: wrap; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 46px; }
        .tag { background: #0056d2; color: #fff; padding: 6px 12px; border-radius: 16px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .tag button { background: none; border: none; color: #fff; cursor: pointer; font-weight: 700; }
        .tag-input-wrapper input { border: none; flex: 1; min-width: 120px; padding: 6px; outline: none; }
        
        @media (max-width: 968px) {
            .creation-grid { grid-template-columns: 1fr; }
            .preview-card { position: static; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo" onclick="window.location.href='/'">
                <i class="fas fa-graduation-cap"></i> LearnHub
            </div>
            <button class="back-btn" onclick="window.location.href='/instructor/dashboard'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Create New Course</h1>
            <p>Fill in the details below to create and publish your course</p>
        </div>

        <div id="alertContainer"></div>

        <div class="creation-grid">
            <div class="main-content">
                <!-- Basic Information -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-info-circle"></i> Basic Information</h2>
                    <div class="form-group">
                        <label>Course Title *</label>
                        <input type="text" id="courseTitle" placeholder="e.g., Complete Python Programming Masterclass" required>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="courseDescription" placeholder="Describe what students will learn in this course..." required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" id="coursePrice" placeholder="0" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="text" id="courseDuration" placeholder="e.g., 8 weeks, 40 hours">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Level *</label>
                            <select id="courseLevel" required>
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="courseCategory">
                                <option value="Programming">Programming</option>
                                <option value="Data Science">Data Science</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Mobile Development">Mobile Development</option>
                                <option value="Design">Design</option>
                                <option value="Business">Business</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tags (Press Enter to add)</label>
                        <div class="tag-input-wrapper" id="tagContainer">
                            <input type="text" id="tagInput" placeholder="Add tags..." onkeypress="handleTagInput(event)">
                        </div>
                    </div>
                </div>

                <!-- Study Materials -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-book"></i> Study Materials</h2>
                    <div class="upload-area" onclick="document.getElementById('materialFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Click to upload files</strong> or drag and drop</p>
                        <p style="font-size: 13px; color: #666; margin-top: 8px;">PDF, DOC, PPT, MP4, ZIP (Max 50MB)</p>
                        <input type="file" id="materialFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.mp4,.zip" multiple>
                    </div>
                    <p style="text-align: center; margin: 16px 0; color: #666;">OR</p>
                    <div class="form-group">
                        <label>External Link (YouTube, Google Drive, etc.)</label>
                        <input type="url" id="materialLink" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Material Title</label>
                        <input type="text" id="materialTitle" placeholder="e.g., Week 1 - Introduction">
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="addMaterial()">
                        <i class="fas fa-plus"></i> Add Material
                    </button>
                    <ul class="materials-list" id="materialsList" style="margin-top: 20px;"></ul>
                </div>

                <!-- Live Classes -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-video"></i> Schedule Live Classes</h2>
                    <div class="form-group">
                        <label>Class Title</label>
                        <input type="text" id="classTitle" placeholder="e.g., Introduction to Python Basics">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="classDate">
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="classTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Meeting Platform</label>
                        <select id="meetingType">
                            <option value="Google Meet">Google Meet</option>
                            <option value="Zoom">Zoom</option>
                            <option value="Microsoft Teams">Microsoft Teams</option>
                            <option value="Custom">Custom Link</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Meeting Link (Optional - auto-generated if empty)</label>
                        <input type="url" id="meetingLink" placeholder="https://meet.google.com/...">
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="addLiveClass()">
                        <i class="fas fa-plus"></i> Schedule Class
                    </button>
                    <div id="liveClassesList" style="margin-top: 20px;"></div>
                </div>

                <!-- Publish Course -->
                <div class="card">
                    <button class="btn btn-success btn-block" onclick="publishCourse()" id="publishBtn">
                        <i class="fas fa-rocket"></i> Create & Publish Course
                    </button>
                    <p style="text-align: center; margin-top: 12px; font-size: 13px; color: #666;">
                        Your course will be visible to all students immediately
                    </p>
                </div>
            </div>

            <div class="sidebar">
                <div class="card preview-card">
                    <h3 class="card-title"><i class="fas fa-eye"></i> Course Preview</h3>
                    <div class="course-preview">
                        <div class="preview-image">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="preview-content">
                            <h3 id="previewTitle">Course Title</h3>
                            <p id="previewDescription">Course description will appear here...</p>
                            <div class="preview-meta">
                                <div class="preview-meta-item">
                                    <strong id="previewPrice">$0</strong>
                                    <span>Price</span>
                                </div>
                                <div class="preview-meta-item">
                                    <strong id="previewLevel">Beginner</strong>
                                    <span>Level</span>
                                </div>
                                <div class="preview-meta-item">
                                    <strong id="previewMaterials">0</strong>
                                    <span>Materials</span>
                                </div>
                                <div class="preview-meta-item">
                                    <strong id="previewClasses">0</strong>
                                    <span>Live Classes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/instructor';
        const token = localStorage.getItem('token');
        const tags = [];
        const materials = [];
        const liveClasses = [];

        if (!token) {
            window.location.href = '/login';
        }

        // Tag handling
        function handleTagInput(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = e.target;
                const tag = input.value.trim();
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                    input.value = '';
                    updatePreview();
                }
            }
        }

        function renderTags() {
            const container = document.getElementById('tagContainer');
            const input = document.getElementById('tagInput');
            container.innerHTML = '';
            tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `${tag} <button onclick="removeTag('${tag}')">Ã—</button>`;
                container.appendChild(tagEl);
            });
            container.appendChild(input);
        }

        function removeTag(tag) {
            const index = tags.indexOf(tag);
            if (index > -1) {
                tags.splice(index, 1);
                renderTags();
                updatePreview();
            }
        }

        // Material handling
        document.getElementById('materialFile').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                materials.push({
                    type: 'file',
                    file: file,
                    title: file.name,
                    id: Date.now() + Math.random()
                });
            });
            renderMaterials();
            updatePreview();
            e.target.value = '';
        });

        function addMaterial() {
            const link = document.getElementById('materialLink').value.trim();
            const title = document.getElementById('materialTitle').value.trim() || 'External Resource';
            
            if (link) {
                materials.push({
                    type: 'link',
                    url: link,
                    title: title,
                    id: Date.now() + Math.random()
                });
                renderMaterials();
                updatePreview();
                document.getElementById('materialLink').value = '';
                document.getElementById('materialTitle').value = '';
            }
        }

        function renderMaterials() {
            const list = document.getElementById('materialsList');
            list.innerHTML = materials.map(m => `
                <li class="material-item">
                    <span>
                        <i class="fas fa-${m.type === 'file' ? 'file-alt' : 'link'}"></i>
                        ${m.title}
                    </span>
                    <button class="remove-btn" onclick="removeMaterial(${m.id})">Remove</button>
                </li>
            `).join('');
        }

        function removeMaterial(id) {
            const index = materials.findIndex(m => m.id === id);
            if (index > -1) {
                materials.splice(index, 1);
                renderMaterials();
                updatePreview();
            }
        }

        // Live class handling
        function addLiveClass() {
            const title = document.getElementById('classTitle').value.trim();
            const date = document.getElementById('classDate').value;
            const time = document.getElementById('classTime').value;
            const meetingType = document.getElementById('meetingType').value;
            const meetingLink = document.getElementById('meetingLink').value.trim();

            if (!title || !date || !time) {
                showAlert('Please fill in class title, date, and time', 'error');
                return;
            }

            const scheduledTime = new Date(`${date}T${time}`);
            
            liveClasses.push({
                title,
                scheduled_time: scheduledTime.toISOString(),
                meeting_type: meetingType,
                meeting_link: meetingLink || `https://meet.google.com/auto-${Date.now()}`,
                id: Date.now() + Math.random()
            });

            renderLiveClasses();
            updatePreview();

            // Clear form
            document.getElementById('classTitle').value = '';
            document.getElementById('classDate').value = '';
            document.getElementById('classTime').value = '';
            document.getElementById('meetingLink').value = '';
        }

        function renderLiveClasses() {
            const container = document.getElementById('liveClassesList');
            container.innerHTML = liveClasses.map(c => `
                <div class="live-class-item">
                    <h4>${c.title}</h4>
                    <p><i class="fas fa-calendar"></i> ${new Date(c.scheduled_time).toLocaleString()}</p>
                    <p><i class="fas fa-video"></i> ${c.meeting_type}</p>
                    <button class="remove-btn" onclick="removeLiveClass(${c.id})" style="margin-top: 8px;">Remove</button>
                </div>
            `).join('');
        }

        function removeLiveClass(id) {
            const index = liveClasses.findIndex(c => c.id === id);
            if (index > -1) {
                liveClasses.splice(index, 1);
                renderLiveClasses();
                updatePreview();
            }
        }

        // Preview update
        function updatePreview() {
            const title = document.getElementById('courseTitle').value || 'Course Title';
            const description = document.getElementById('courseDescription').value || 'Course description will appear here...';
            const price = document.getElementById('coursePrice').value || '0';
            const level = document.getElementById('courseLevel').value;

            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewDescription').textContent = description.substring(0, 100) + (description.length > 100 ? '...' : '');
            document.getElementById('previewPrice').textContent = '$' + price;
            document.getElementById('previewLevel').textContent = level;
            document.getElementById('previewMaterials').textContent = materials.length;
            document.getElementById('previewClasses').textContent = liveClasses.length;
        }

        // Add event listeners for real-time preview
        ['courseTitle', 'courseDescription', 'coursePrice', 'courseLevel'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        // Publish course
        async function publishCourse() {
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDescription').value.trim();

            if (!title || !description) {
                showAlert('Please fill in course title and description', 'error');
                return;
            }

            const publishBtn = document.getElementById('publishBtn');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Course...';

            try {
                // Step 1: Create course
                const courseData = {
                    title,
                    description,
                    price: parseFloat(document.getElementById('coursePrice').value) || 0,
                    duration: document.getElementById('courseDuration').value.trim(),
                    level: document.getElementById('courseLevel').value,
                    category: document.getElementById('courseCategory').value,
                    tags: tags
                };

                const courseRes = await fetch(`${API_BASE}/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(courseData)
                });

                const courseResult = await courseRes.json();
                
                if (!courseResult.success) {
                    throw new Error(courseResult.message || 'Failed to create course');
                }

                const courseId = courseResult.course_id;
                showAlert('Course created successfully! Adding materials and classes...', 'success');

                // Step 2: Upload materials
                for (const material of materials) {
                    if (material.type === 'file') {
                        const formData = new FormData();
                        formData.append('file', material.file);
                        formData.append('title', material.title);
                        
                        await fetch(`${API_BASE}/courses/${courseId}/materials`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });
                    } else {
                        await fetch(`${API_BASE}/courses/${courseId}/materials`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                title: material.title,
                                url: material.url,
                                type: 'link'
                            })
                        });
                    }
                }

                // Step 3: Schedule live classes
                for (const liveClass of liveClasses) {
                    await fetch(`${API_BASE}/live-classes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            course_id: courseId,
                            title: liveClass.title,
                            scheduled_time: liveClass.scheduled_time,
                            meeting_type: liveClass.meeting_type,
                            meeting_link: liveClass.meeting_link
                        })
                    });
                }

                showAlert('Course published successfully! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '/instructor/dashboard';
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                showAlert(error.message || 'Failed to create course', 'error');
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="fas fa-rocket"></i> Create & Publish Course';
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
